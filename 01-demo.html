<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebAuthn Demo (No Server)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
    button { padding: 0.5em 1em; margin: 1em 0; }
    pre { background: #f0f0f0; padding: 1em; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ” WebAuthn Demo (No Server)</h1>
  <button id="registerBtn">æ³¨å†Œå‡­æ®</button>
  <button id="loginBtn">ä½¿ç”¨å‡­æ®ç™»å½•</button>
  <pre id="output"></pre>

  <script>
    const output = document.getElementById('output');
    const log = msg => output.textContent += msg + '\n';

    // å·¥å…·å‡½æ•°ï¼šbase64 <=> ArrayBuffer è½¬æ¢
    const bufferToBase64 = buffer => btoa(String.fromCharCode(...new Uint8Array(buffer)));
    const base64ToBuffer = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0)).buffer;

    // ç”Ÿæˆä¸€ä¸ªéšæœº challenge
    function generateChallenge(len = 32) {
      const buffer = new Uint8Array(len);
      window.crypto.getRandomValues(buffer);
      return buffer;
    }

    // æ³¨å†Œé€»è¾‘
    document.getElementById('registerBtn').onclick = async () => {
      output.textContent = '';
      log('å¼€å§‹æ³¨å†Œ...');

      const challenge = generateChallenge();
      const publicKey = {
        challenge,
        rp: { name: "Demo Site" },
        user: {
          id: Uint8Array.from("123456", c => c.charCodeAt(0)),
          name: "user@example.com",
          displayName: "æµ‹è¯•ç”¨æˆ·"
        },
        pubKeyCredParams: [
          { type: "public-key", alg: -7 } // ES256
        ],
        authenticatorSelection: {
          // authenticatorAttachment: "platform",
          userVerification: "preferred"
        },
        timeout: 60000,
        attestation: "none"
      };

      try {
        const cred = await navigator.credentials.create({ publicKey });

        const rawIdBase64 = bufferToBase64(cred.rawId);
        localStorage.setItem('credentialId', rawIdBase64);
        log('âœ… æ³¨å†ŒæˆåŠŸï¼å‡­æ® ID å·²ä¿å­˜ï¼š');
        log(rawIdBase64);
      } catch (err) {
        log('âŒ æ³¨å†Œå¤±è´¥ï¼š' + err);
      }
    };

    // ç™»å½•é€»è¾‘
    document.getElementById('loginBtn').onclick = async () => {
      output.textContent = '';
      log('å¼€å§‹ç™»å½•...');

      const storedId = localStorage.getItem('credentialId');
      if (!storedId) {
        log('âŒ æœªæ‰¾åˆ°å·²æ³¨å†Œçš„å‡­æ® IDï¼Œè¯·å…ˆæ³¨å†Œ');
        return;
      }

      const challenge = generateChallenge();
      const publicKey = {
        challenge,
        allowCredentials: [
          {
            type: 'public-key',
            id: base64ToBuffer(storedId),
            transports: ["internal"]
          }
        ],
        timeout: 60000,
        userVerification: "preferred"
      };

      try {
        const assertion = await navigator.credentials.get({ publicKey });
        log('âœ… ç™»å½•æˆåŠŸï¼');
        log('è®¤è¯ä¿¡æ¯å¦‚ä¸‹ï¼š');
        log(JSON.stringify({
          id: assertion.id,
          type: assertion.type,
          rawId: bufferToBase64(assertion.rawId)
        }, null, 2));
      } catch (err) {
        log('âŒ ç™»å½•å¤±è´¥ï¼š' + err);
      }
    };
  </script>
</body>
</html>
